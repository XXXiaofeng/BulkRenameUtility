# Nginx缓存配置优化

# 1. 缓存区域配置
proxy_cache_path /var/cache/nginx/seo levels=1:2 keys_zone=seo_cache:100m max_size=2g inactive=24h use_temp_path=off;
proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=static_cache:50m max_size=500m inactive=30d use_temp_path=off;

# 2. 缓存键配置
map $request_method $cache_key_method {
    default "";
    GET "get";
    HEAD "head";
}

map $http_accept $cache_key_accept {
    default "";
    ~*text/html "html";
    ~*application/json "json";
}

# 3. 合并缓存键
map $is_bot$request_uri $full_cache_key {
    default $scheme|$host|$request_uri|$cache_key_method|$cache_key_accept;
}

# 4. 缓存配置
proxy_cache_valid 200 302 1h;
proxy_cache_valid 404 1m;
proxy_cache_valid 500 502 503 504 0s;
proxy_cache_key $full_cache_key;
proxy_cache_lock on;
proxy_cache_lock_age 5s;
proxy_cache_lock_timeout 5s;
proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
proxy_cache_background_update on;

# 5. 缓存绕过和刷新
map $http_cache_control $bypass_cache {
    default 0;
    ~*no-cache 1;
    ~*no-store 1;
    ~*max-age=0 1;
}

map $http_pragma $bypass_cache_pragma {
    default 0;
    ~*no-cache 1;
}

# 6. 最终缓存绕过决策
map $bypass_cache$bypass_cache_pragma $skip_cache {
    default 0;
    ~*1 1;
}